<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>VFR Nav Log + Airport Frequencies</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icon-192.png" />
    <meta name="theme-color" content="#161b22" />

    <!-- Bootstrap 5 CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <style>
      :root {
        --bs-body-bg: #0d1117;
        --bs-body-color: #c9d1d9;
        --bs-table-bg: #161b22;
        --bs-border-color: #30363d;
        --bs-primary: #58a6ff;
        --bs-primary-hover: #238636;
      }

      body {
        background-color: var(--bs-body-bg);
        color: var(--bs-body-color);
        font-family: Arial, sans-serif;
        padding: 15px;
        margin: 0;
      }

      h2,
      h3 {
        color: var(--bs-primary);
      }

      /* Override Bootstrap table dark styling */
      table {
        border: 1px solid var(--bs-border-color);
      }
      thead {
        background-color: var(--bs-table-bg);
      }
      th,
      td {
        border: 1px solid var(--bs-border-color);
        font-size: 14px;
        text-align: center;
        vertical-align: middle;
        color: var(--bs-body-color);
        padding: 0.5rem 0.75rem;
      }

      /* Inputs inside tables */
      input[type="text"],
      input[type="number"] {
        background-color: var(--bs-table-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
        width: 100%;
        padding: 4px 6px;
        font-size: 14px;
        border-radius: 0.25rem;
        box-sizing: border-box;
      }
      input[readonly] {
        background-color: transparent;
        border-color: transparent;
        color: var(--bs-primary);
        font-weight: 600;
      }

      /* Buttons */
      button {
        border-radius: 0.3rem;
        font-weight: 600;
      }
      button.btn-primary {
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
      }
      button.btn-primary:hover {
        background-color: var(--bs-primary-hover);
        border-color: var(--bs-primary-hover);
      }

      /* Frequency section flex layout */
      .freq-section {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        margin-top: 20px;
      }
      .freq-block {
        flex: 1 1 300px;
        min-width: 280px;
        background-color: var(--bs-table-bg);
        padding: 15px;
        border-radius: 0.5rem;
        box-shadow: 0 0 8px rgba(88, 166, 255, 0.2);
      }

      label {
        font-weight: 600;
        display: block;
        margin-bottom: 0.3rem;
        color: var(--bs-primary);
      }

      /* Responsive table wrapper for horizontal scroll */
      .table-responsive {
        overflow-x: auto;
        max-width: 100%;
        margin-bottom: 1rem;
      }

      /* Adjust input widths inside nav log table */
      #navlog input[type="text"],
      #navlog input[type="number"] {
        min-width: 50px;
        max-width: 90px;
      }

      /* Wider inputs for frequency inputs */
      #depCode,
      #arrCode {
        width: 100%;
        max-width: 120px;
        padding: 8px 10px;
        font-size: 1rem;
        border-radius: 0.4rem;
        border: 1px solid var(--bs-border-color);
        background-color: var(--bs-table-bg);
        color: var(--bs-body-color);
        box-sizing: border-box;
      }

      /* Heading margins */
      h2 {
        margin-top: 1rem;
        margin-bottom: 0.75rem;
      }
      h3 {
        margin-bottom: 1rem;
      }

      /* On small screens stack freq blocks */
      @media (max-width: 600px) {
        .freq-section {
          flex-direction: column;
        }
      }

      /* Adjustments for iOS keyboard */
      input:focus,
      textarea:focus {
        outline: 2px solid var(--bs-primary);
        outline-offset: 2px;
      }
    </style>
  </head>

  <body>
    <div class="container-fluid p-0">
      <h2>VFR Navigation Log</h2>
      <button
        type="button"
        class="btn btn-primary mb-3"
        onclick="addRow()"
        aria-label="Add navigation log row"
      >
        Add Row
      </button>

      <div class="table-responsive">
        <table
          id="navlog"
          class="table table-bordered table-striped table-hover align-middle"
          aria-describedby="navlogDesc"
        >
          <caption id="navlogDesc" class="visually-hidden">
            VFR Navigation log inputs and calculations
          </caption>
          <thead>
            <tr>
              <th>CP</th>
              <th>VOR Ident</th>
              <th>VOR Freq</th>
              <th>Course</th>
              <th>Wind Dir</th>
              <th>Wind Vel</th>
              <th>TAS</th>
              <th>TC</th>
              <th>WCA</th>
              <th>TH</th>
              <th>Var</th>
              <th>MH</th>
              <th>Dist</th>
              <th>GS</th>
              <th>ETE</th>
              <th>GPH</th>
              <th>Fuel</th>
              <th>✖</th>
            </tr>
          </thead>
          <tbody id="navlog-body"></tbody>
        </table>
      </div>

      <h2>Airport Frequencies</h2>
      <div class="freq-section">
        <!-- Departure -->
        <div class="freq-block" role="region" aria-labelledby="depHeading">
          <h3 id="depHeading">Departure Airport</h3>
          <label for="depCode">ICAO code:</label>
          <input
            id="depCode"
            maxlength="4"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="characters"
            spellcheck="false"
            aria-describedby="dep-details"
            oninput="fetchAirport(this.value.toUpperCase(), 'dep')"
            type="text"
            inputmode="text"
            aria-label="Departure Airport ICAO code"
          />
          <div
            id="dep-details"
            class="mb-3 mt-2 text-break"
            aria-live="polite"
            aria-atomic="true"
          ></div>
          <div class="table-responsive">
            <table
              id="dep-table"
              class="table table-bordered table-hover"
              aria-describedby="depFreqDesc"
            >
              <caption id="depFreqDesc" class="visually-hidden">
                Frequencies for departure airport
              </caption>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Frequency (MHz)</th>
                </tr>
              </thead>
              <tbody id="dep-body">
                <tr>
                  <td colspan="3">Enter ICAO code</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Arrival -->
        <div class="freq-block" role="region" aria-labelledby="arrHeading">
          <h3 id="arrHeading">Arrival Airport</h3>
          <label for="arrCode">ICAO code:</label>
          <input
            id="arrCode"
            maxlength="4"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="characters"
            spellcheck="false"
            aria-describedby="arr-details"
            oninput="fetchAirport(this.value.toUpperCase(), 'arr')"
            type="text"
            inputmode="text"
            aria-label="Arrival Airport ICAO code"
          />
          <div
            id="arr-details"
            class="mb-3 mt-2 text-break"
            aria-live="polite"
            aria-atomic="true"
          ></div>
          <div class="table-responsive">
            <table
              id="arr-table"
              class="table table-bordered table-hover"
              aria-describedby="arrFreqDesc"
            >
              <caption id="arrFreqDesc" class="visually-hidden">
                Frequencies for arrival airport
              </caption>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Description</th>
                  <th>Frequency (MHz)</th>
                </tr>
              </thead>
              <tbody id="arr-body">
                <tr>
                  <td colspan="3">Enter ICAO code</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let rowCount = 0;

      function degToRad(d) {
        return (d * Math.PI) / 180;
      }

      function radToDeg(r) {
        return (r * 180) / Math.PI;
      }

      function addRow() {
        const i = rowCount++;
        const tbody = document.getElementById("navlog-body");
        const tr = document.createElement("tr");
        tr.id = `row${i}`;
        tr.innerHTML = `
          <td><input id="cp${i}" class="form-control form-control-sm" type="text" /></td>
          <td><input id="vorIdent${i}" class="form-control form-control-sm" type="text" /></td>
          <td><input id="vorFreq${i}" class="form-control form-control-sm" type="text" /></td>
          <td><input id="course${i}" class="form-control form-control-sm" type="number"
            oninput="document.getElementById('tc${i}').value = this.value; calculateRow(${i})" /></td>
          <td><input id="windDir${i}" class="form-control form-control-sm" type="number" oninput="calculateRow(${i})" /></td>
          <td><input id="windVel${i}" class="form-control form-control-sm" type="number" oninput="calculateRow(${i})" /></td>
          <td><input id="tas${i}" class="form-control form-control-sm" type="number" oninput="calculateRow(${i})" /></td>
          <td><input id="tc${i}" class="form-control form-control-sm" type="number" readonly /></td>
          <td><input id="wca${i}" class="form-control form-control-sm" readonly /></td>
          <td><input id="th${i}" class="form-control form-control-sm" readonly /></td>
          <td><input id="var${i}" class="form-control form-control-sm" type="number" oninput="calculateRow(${i})" /></td>
          <td><input id="mh${i}" class="form-control form-control-sm" readonly /></td>
          <td><input id="dist${i}" class="form-control form-control-sm" type="number" oninput="calculateRow(${i})" /></td>
          <td><input id="gs${i}" class="form-control form-control-sm" readonly /></td>
          <td><input id="ete${i}" class="form-control form-control-sm" readonly /></td>
          <td><input id="gph${i}" class="form-control form-control-sm" type="number" value="8" oninput="calculateRow(${i})" /></td>
          <td><input id="fuel${i}" class="form-control form-control-sm" readonly /></td>
          <td><button class="btn btn-danger btn-sm" onclick="removeRow(${i})" aria-label="Remove row ${i}">✖</button></td>
        `;
        tbody.appendChild(tr);
        calculateRow(i);
      }

      function removeRow(i) {
        const row = document.getElementById(`row${i}`);
        if (row) row.remove();
      }

      function calculateRow(i) {
        const get = (id) =>
          parseFloat(document.getElementById(id + i)?.value) || 0;
        const tc = get("tc"),
          wd = get("windDir"),
          wv = get("windVel"),
          tas = get("tas");
        const v = get("var"),
          d = get("dist"),
          gph = get("gph");
        if (!tas || !d) return;
        const wa = degToRad(wd - tc),
          cross = wv * Math.sin(wa);
        let wca = 0;
        try {
          wca = radToDeg(Math.asin(cross / tas));
        } catch {}
        const th = tc + wca,
          mh = th + v;
        const head = wv * Math.cos(wa),
          gs = tas - head;
        const ete = d / gs,
          m = Math.floor(ete),
          s = Math.round((ete - m) * 60);
        const eteFmt = `${m}:${s.toString().padStart(2, "0")}`,
          fuel = gph * ete;
        document.getElementById(`wca${i}`).value = wca.toFixed(1);
        document.getElementById(`th${i}`).value = th.toFixed(1);
        document.getElementById(`mh${i}`).value = mh.toFixed(1);
        document.getElementById(`gs${i}`).value = gs.toFixed(1);
        document.getElementById(`ete${i}`).value = eteFmt;
        document.getElementById(`fuel${i}`).value = fuel.toFixed(1);
      }

      async function fetchAirport(code, type) {
        const body = document.getElementById(`${type}-body`);
        const detailDiv = document.getElementById(`${type}-details`);
        if (code.length !== 4) {
          body.innerHTML = `<tr><td colspan="3">Enter valid ICAO code (e.g. KJFK)</td></tr>`;
          detailDiv.innerHTML = "";
          return;
        }
        const url = `https://airportdb.io/api/v1/airport/${code}`;
        try {
          const resp = await fetch(url);
          if (!resp.ok) throw new Error("Not found");
          const data = await resp.json();

          const runways = (data.runways || [])
            .map(
              (rw) =>
                `RWY ${rw.he_ident || "N/A"} → ${rw.le_ident || "N/A"} (${
                  rw.length_ft
                }ft / ${rw.width_ft})ft`
            )
            .join("<br>");

          detailDiv.innerHTML = `
            <p><strong>Field Elevation:</strong> ${
              data.elevation_ft || "N/A"
            } ft</p>
            <p><strong>Runway Length:</strong> ${
              data.runways?.[0]?.length_ft || "N/A"
            } ft</p>
            <p><strong>Runway Width:</strong> ${
              data.runways?.[0]?.width_ft || "N/A"
            } ft</p>
            <p><strong>Available Runways:</strong><br>${runways || "N/A"}</p>
          `;

          const freqs =
            data.freqs || data.frequencies || data.communication || data.comms;
          if (!Array.isArray(freqs) || !freqs.length) {
            body.innerHTML =
              '<tr><td colspan="3">No frequencies found</td></tr>';
            return;
          }
          body.innerHTML = "";
          freqs.forEach((fq) => {
            body.insertAdjacentHTML(
              "beforeend",
              `<tr><td>${fq.type || "Unknown"}</td><td>${
                fq.description || "Unknown"
              }</td><td>${fq.frequency_mhz || fq.frequency}</td></tr>`
            );
          });
        } catch (e) {
          body.innerHTML = `<tr><td colspan="3">Airport not found</td></tr>`;
          detailDiv.innerHTML = "";
        }
      }

      // Add default row on load
      addRow();

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker
          .register("service-worker.js")
          .then(() => console.log("Service Worker registered"))
          .catch((err) => console.log("SW registration failed:", err));
      }
    </script>
  </body>
</html>
